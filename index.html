<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vulnerability Reporting Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --primary-color: #3b82f6;
            --secondary-color: #8b5cf6;
            --success-color: #22c55e;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --critical-color: #991b1b;
            --text-color: #111827;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
            --gradient-bg: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        }

        body {
            font-family: 'Inter', sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            background: var(--gradient-bg);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2.5rem;
            animation: fadeIn 1s ease-in;
        }

        .container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .container:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }

        .input-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
        }

        label {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: block;
            color: var(--text-color);
        }

        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95rem;
            background: #fff;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="file"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        button {
            background: var(--gradient-bg);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .download-btn {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .download-btn:hover:not(:disabled) {
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .status {
            margin: 1.5rem 0;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.95rem;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .error {
            background: #fee2e2;
            color: var(--error-color);
            border: 1px solid #fecaca;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 1rem 0;
            font-size: 0.9rem;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        th, td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: var(--gradient-bg);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th.severity-critical { background: var(--critical-color); color: white; }
        th.severity-high { background: var(--error-color); color: white; }
        th.severity-medium { background: var(--warning-color); color: white; }
        th.severity-low { background: var(--success-color); color: white; }

        tr {
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        tr:hover {
            background: #eff6ff;
            transform: translateX(4px);
        }

        .severity-critical { color: var(--critical-color); font-weight: 600; }
        .severity-high { color: var(--error-color); font-weight: 600; }
        .severity-medium { color: var(--warning-color); font-weight: 600; }
        .severity-low { color: var(--success-color); font-weight: 600; }

        .tab-container {
            margin-top: 1.5rem;
        }

        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .tab-button {
            padding: 10px 24px;
            background: #e5e7eb;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: var(--gradient-bg);
            color: white;
        }

        .tab-button:hover:not(.active) {
            background: #d1d5db;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        .summary-card {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-4px);
        }

        .summary-card h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0 0 1rem;
            color: var(--text-color);
        }

        .summary-grid, .severity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .stat-item {
            background: linear-gradient(145deg, #f9fafb, #e5e7eb);
            padding: 1.2rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s ease;
        }

        .stat-item:hover {
            transform: scale(1.03);
        }

        .stat-item h4 {
            font-size: 0.9rem;
            color: #6b7280;
            margin: 0 0 0.5rem;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient-bg);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-value.critical { background: linear-gradient(135deg, #991b1b, #dc2626); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-value.high { background: linear-gradient(135deg, #dc2626, #f87171); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-value.medium { background: linear-gradient(135deg, #f59e0b, #fbbf24); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-value.low { background: linear-gradient(135deg, #22c55e, #16a34a); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .cve-id {
            white-space: nowrap;
            font-weight: 500;
        }

        .clickable {
            cursor: pointer;
            color: var(--primary-color);
            font-weight: 600;
            text-decoration: underline;
            transition: color 0.2s ease;
        }

        .clickable:hover {
            color: var(--secondary-color);
        }

        .cve-details-row {
            display: none;
            background: #f9fafb;
        }

        .cve-details-cell {
            padding: 14px;
            word-break: break-word;
            font-size: 0.9rem;
        }

        .expanded + .cve-details-row {
            display: table-row;
            animation: slideIn 0.3s ease;
        }

        .expanded {
            background: #eff6ff;
        }

        .severity-section {
            margin-bottom: 0.5rem;
        }

        .severity-section h4 {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .nginx-container {
            margin-top: 2rem;
        }

        .nginx-toggle {
            background: linear-gradient(145deg, #f9fafb, #e5e7eb);
            border: none;
            padding: 14px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .nginx-toggle:hover {
            background: linear-gradient(145deg, #e5e7eb, #d1d5db);
            transform: translateY(-2px);
        }

        .nginx-toggle:after {
            content: '+';
            font-size: 1.3rem;
            font-weight: 700;
        }

        .nginx-toggle.expanded:after {
            content: '-';
        }

        .nginx-content {
            display: none;
            padding: 1.5rem;
            background: #fff;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
        }

        .nginx-content.expanded {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 1.5rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Vulnerability Reporting Dashboard</h1>
        
        <div class="input-section">
            <label for="csvFile">Upload Vulnerability CSV:</label>
            <input type="file" id="csvFile" accept=".csv,.txt">
            <button id="processBtn" disabled>Process CSV</button>
            <div id="status" class="status"></div>
            <div id="spinner" class="spinner"></div>
        </div>
        
        <div class="output-section" id="outputSection" style="display: none;">
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="summaryView">Vulnerability Summary</button>
                    <button class="tab-button" data-tab="serviceView">Service View</button>
                    <button class="tab-button" data-tab="cveView">CVE View</button>
                    <button class="tab-button" data-tab="nginxView">Nginx View</button>
                </div>
                
                <div id="summaryView" class="tab-content active">
                    <div class="summary-card">
                        <h3>Vulnerability Summary</h3>
                        <div class="summary-grid" id="mainStats"></div>
                        <div class="severity-grid" id="severityStats"></div>
                    </div>
                    <button id="downloadSummaryBtn" class="download-btn">Download Summary CSV</button>
                </div>
                
                <div id="serviceView" class="tab-content">
                    <div class="table-header">
                        <div class="table-title">Service View</div>
                    </div>
                    <button id="downloadServiceBtn" class="download-btn">Download Service View CSV</button>
                    <div id="serviceTableContainer"></div>
                </div>
                
                <div id="cveView" class="tab-content">
                    <div class="table-header">
                        <div class="table-title">CVE View</div>
                    </div>
                    <button id="downloadCveBtn" class="download-btn">Download CVE View CSV</button>
                    <div id="cveTableContainer"></div>
                </div>
                
                <div id="nginxView" class="tab-content">
                    <div class="nginx-container">
                        <div class="nginx-toggle" data-target="nginxSummary">Nginx Summary</div>
                        <div id="nginxSummary" class="nginx-content">
                            <div class="summary-card">
                                <h3>Nginx Vulnerability Summary</h3>
                                <div class="summary-grid" id="nginxMainStats"></div>
                                <div class="severity-grid" id="nginxSeverityStats"></div>
                            </div>
                        </div>
                        
                        <div class="nginx-toggle" data-target="nginxCveView">Nginx CVE View</div>
                        <div id="nginxCveView" class="nginx-content">
                            <button id="downloadNginxCveBtn" class="download-btn">Download Nginx CVE View CSV</button>
                            <div id="nginxCveTableContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM elements
            const elements = {
                csvFileInput: document.getElementById('csvFile'),
                processBtn: document.getElementById('processBtn'),
                statusDiv: document.getElementById('status'),
                spinner: document.getElementById('spinner'),
                outputSection: document.getElementById('outputSection'),
                mainStats: document.getElementById('mainStats'),
                severityStats: document.getElementById('severityStats'),
                serviceTableContainer: document.getElementById('serviceTableContainer'),
                cveTableContainer: document.getElementById('cveTableContainer'),
                nginxMainStats: document.getElementById('nginxMainStats'),
                nginxSeverityStats: document.getElementById('nginxSeverityStats'),
                nginxCveTableContainer: document.getElementById('nginxCveTableContainer'),
                downloadSummaryBtn: document.getElementById('downloadSummaryBtn'),
                downloadServiceBtn: document.getElementById('downloadServiceBtn'),
                downloadCveBtn: document.getElementById('downloadCveBtn'),
                downloadNginxCveBtn: document.getElementById('downloadNginxCveBtn'),
                tabButtons: document.querySelectorAll('.tab-button'),
                tabContents: document.querySelectorAll('.tab-content'),
                nginxToggles: document.querySelectorAll('.nginx-toggle')
            };

            // Data storage
            let dataStore = {
                processedData: [],
                nginxData: [],
                serviceViewData: [],
                cveViewData: [],
                nginxCveViewData: [],
                summaryData: {},
                nginxSummaryData: {}
            };

            // Initialize event listeners
            function initEventListeners() {
                elements.csvFileInput.addEventListener('change', () => {
                    elements.processBtn.disabled = !elements.csvFileInput.files.length;
                });

                elements.processBtn.addEventListener('click', processFile);
                elements.downloadSummaryBtn.addEventListener('click', () => downloadCSV(dataStore.summaryData.stats, 'vulnerability_summary'));
                elements.downloadServiceBtn.addEventListener('click', () => downloadCSV(dataStore.serviceViewData, 'service_view'));
                elements.downloadCveBtn.addEventListener('click', () => downloadCSV(dataStore.cveViewData, 'cve_view'));
                elements.downloadNginxCveBtn.addEventListener('click', () => downloadCSV(dataStore.nginxCveViewData, 'nginx_cve_view'));

                elements.tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        elements.tabButtons.forEach(btn => btn.classList.remove('active'));
                        elements.tabContents.forEach(content => content.classList.remove('active'));
                        button.classList.add('active');
                        document.getElementById(button.dataset.tab).classList.add('active');
                    });
                });

                elements.nginxToggles.forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        const targetId = toggle.getAttribute('data-target');
                        const target = document.getElementById(targetId);
                        toggle.classList.toggle('expanded');
                        target.classList.toggle('expanded');
                    });
                });
            }

            // Main processing function
            async function processFile() {
                const file = elements.csvFileInput.files[0];
                if (!file) return;

                elements.processBtn.disabled = true;
                elements.spinner.style.display = 'block';
                elements.statusDiv.style.display = 'none';

                try {
                    const csvData = await readFile(file);
                    const { nonNginxData, nginxData } = processCSV(csvData);
                    dataStore.processedData = nonNginxData;
                    dataStore.nginxData = nginxData;

                    // Prepare data for different views
                    dataStore.serviceViewData = createServiceViewData(nonNginxData);
                    dataStore.cveViewData = createCveViewData(nonNginxData);
                    dataStore.nginxCveViewData = createCveViewData(nginxData, true);
                    dataStore.summaryData = createSummaryData(nonNginxData, dataStore.cveViewData);
                    dataStore.nginxSummaryData = createSummaryData(nginxData, dataStore.nginxCveViewData);

                    // Display all views
                    displaySummaryStats(dataStore.summaryData);
                    displayNginxSummaryStats(dataStore.nginxSummaryData);
                    displayServiceView(dataStore.serviceViewData);
                    displayCveView(dataStore.cveViewData);
                    displayNginxCveView(dataStore.nginxCveViewData);

                    showStatus('CSV processed successfully! Found columns processed.', 'success');
                    elements.outputSection.style.display = 'block';
                } catch (error) {
                    showStatus(`Error processing CSV: ${error.message}`, 'error');
                    console.error(error);
                } finally {
                    elements.processBtn.disabled = false;
                    elements.spinner.style.display = 'none';
                }
            }

            // Read file asynchronously
            function readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(new Error('Error reading file'));
                    reader.readAsText(file);
                });
            }

            // Process CSV data
            function processCSV(csvData) {
                const lines = csvData.split('\n').filter(line => line.trim());
                if (lines.length < 2) throw new Error('CSV must have header row and at least one data row');

                // Detect delimiter
                let delimiter = lines[0].includes('\t') ? '\t' : ',';
                const headers = lines[0].split(delimiter).map(h => h.trim());

                // Define required columns
                const requiredColumns = {
                    severity: ['severity', 'vulnerability severity', 'risk', 'risk level'],
                    vulnId: ['vulnid', 'vuln id', 'cve', 'cveid', 'cve id']
                };

                // Service identifier columns
                const serviceColumns = {
                    repositoryName: ['repositoryname', 'repository name', 'repository', 'repo', 'servicename'],
                    resourceId: ['resourceid', 'resource id', 'resource']
                };

                // Optional columns
                const optionalColumns = {
                    packageName: ['packagename', 'package name', 'package'],
                    category: ['category'],
                    version: ['version', 'installed version', 'current version'],
                    fixedVersion: ['fixedversion', 'fixed version', 'patched version'],
                    vendor: ['vendor'],
                    fixStatus: ['fixstatus', 'fix status']
                };

                // Find column indices
                const findColumnIndex = (possibleNames) => {
                    const lowerHeaders = headers.map(h => h.toLowerCase());
                    for (const name of possibleNames) {
                        const index = lowerHeaders.indexOf(name.toLowerCase());
                        if (index !== -1) return index;
                    }
                    return -1;
                };

                const indices = {};
                const foundColumns = [];
                let missingRequired = [];
                let mode = null; // 'repository' or 'resource'

                // Check required columns
                for (const [key, possibleNames] of Object.entries(requiredColumns)) {
                    indices[key] = findColumnIndex(possibleNames);
                    if (indices[key] === -1) {
                        missingRequired.push(`${key} (expected: ${possibleNames.join(', ')})`);
                    } else {
                        foundColumns.push(headers[indices[key]]);
                    }
                }

                if (missingRequired.length > 0) {
                    throw new Error(`Missing required columns: ${missingRequired.join(', ')}. Found columns: ${headers.join(', ')}`);
                }

                // Check for service identifier
                indices.repositoryName = findColumnIndex(serviceColumns.repositoryName);
                if (indices.repositoryName !== -1) {
                    mode = 'repository';
                    foundColumns.push(headers[indices.repositoryName]);
                } else {
                    indices.resourceId = findColumnIndex(serviceColumns.resourceId);
                    if (indices.resourceId !== -1) {
                        mode = 'resource';
                        foundColumns.push(headers[indices.resourceId]);
                    } else {
                        throw new Error(`Missing service identifier column: repositoryName or resourceId required. Found columns: ${headers.join(', ')}`);
                    }
                }

                // Check optional columns
                const missingOptional = [];
                for (const [key, possibleNames] of Object.entries(optionalColumns)) {
                    indices[key] = findColumnIndex(possibleNames);
                    if (indices[key] !== -1) {
                        foundColumns.push(headers[indices[key]]);
                    } else {
                        missingOptional.push(`${key} (expected: ${possibleNames.join(', ')})`);
                    }
                }

                // Report column status
                let statusMessage = `Found columns: ${foundColumns.join(', ') || 'none'}. Using mode: ${mode}`;
                if (missingOptional.length > 0) {
                    statusMessage += `\nOptional columns not found (using defaults): ${missingOptional.join(', ')}`;
                }
                console.log(statusMessage);

                const nonNginxData = [];
                const nginxData = [];

                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;

                    const values = lines[i].split(delimiter);
                    const rowData = {
                        severity: values[indices.severity]?.trim(),
                        vulnId: values[indices.vulnId]?.trim(),
                        packageName: values[indices.packageName]?.trim() || 'N/A',
                        category: values[indices.category]?.trim() || 'N/A',
                        version: values[indices.version]?.trim() || 'N/A',
                        fixedVersion: values[indices.fixedVersion]?.trim() || 'N/A',
                        vendor: values[indices.vendor]?.trim() || 'N/A',
                        fixStatus: values[indices.fixStatus]?.trim() || 'N/A'
                    };

                    let serviceIdentifier;
                    if (mode === 'repository') {
                        serviceIdentifier = values[indices.repositoryName]?.trim();
                    } else if (mode === 'resource') {
                        serviceIdentifier = values[indices.resourceId]?.trim();
                    }

                    if (!rowData.severity || !rowData.vulnId || !serviceIdentifier) continue;

                    // Extract service name based on mode
                    let serviceName = 'Unknown Service';
                    if (mode === 'repository') {
                        serviceName = serviceIdentifier.includes('/')
                            ? serviceIdentifier.split('/').pop()
                            : serviceIdentifier;
                    } else if (mode === 'resource') {
                        // Take the part after the last '/'
                        const lastPart = serviceIdentifier.split('/').pop();
                        // Try to match cibg-<serviceName>-service in the last part
                        const cibgMatch = lastPart.match(/cibg-(.*?)-service/i);
                        if (cibgMatch && cibgMatch[1]) {
                            serviceName = cibgMatch[1];
                        } else {
                            // Fallback to extracting before '-image' in the last part
                            const imageMatch = lastPart.match(/(.*?)(?:-image)?$/i);
                            serviceName = imageMatch && imageMatch[1] ? imageMatch[1] : lastPart;
                        }
                    }

                    const item = {
                        serviceName,
                        cveId: rowData.vulnId,
                        severity: rowData.severity,
                        packageName: rowData.packageName,
                        category: rowData.category,
                        version: rowData.version,
                        fixedVersion: rowData.fixedVersion,
                        vendor: rowData.vendor,
                        fixStatus: rowData.fixStatus,
                        fullRepositoryName: serviceIdentifier
                    };

                    // Separate Nginx and non-Nginx data
                    if (serviceIdentifier.toLowerCase().includes('nginx')) {
                        nginxData.push(item);
                    } else {
                        nonNginxData.push(item);
                    }
                }

                return { nonNginxData, nginxData };
            }

            // Create service view data
            function createServiceViewData(data) {
                const serviceMap = new Map();

                data.forEach(item => {
                    if (!serviceMap.has(item.serviceName)) {
                        serviceMap.set(item.serviceName, {
                            serviceName: item.serviceName,
                            uniqueCves: new Set(),
                            cveDetails: [],
                            severityCounts: { Critical: 0, High: 0, Medium: 0, Low: 0 }
                        });
                    }

                    const entry = serviceMap.get(item.serviceName);
                    entry.uniqueCves.add(item.cveId);
                    entry.cveDetails.push({
                        cveId: item.cveId,
                        severity: getNormalizedSeverity(item.severity),
                        severityLevel: getSeverityLevel(item.severity)
                    });
                    const severity = getNormalizedSeverity(item.severity);
                    if (severity && entry.severityCounts[severity] !== undefined) {
                        entry.severityCounts[severity]++;
                    }
                });

                return Array.from(serviceMap.values())
                    .map(entry => ({
                        serviceName: entry.serviceName,
                        uniqueCveCount: entry.uniqueCves.size,
                        cveDetails: entry.cveDetails.sort((a, b) => b.severityLevel - a.severityLevel),
                        criticalCount: entry.severityCounts.Critical,
                        highCount: entry.severityCounts.High,
                        mediumCount: entry.severityCounts.Medium,
                        lowCount: entry.severityCounts.Low
                    }))
                    .sort((a, b) => b.uniqueCveCount - a.uniqueCveCount);
            }

            // Create CVE view data
            function createCveViewData(data, isNginx = false) {
                const cveMap = new Map();

                data.forEach(item => {
                    if (!cveMap.has(item.cveId)) {
                        cveMap.set(item.cveId, {
                            cveId: item.cveId,
                            severity: item.severity,
                            packageName: item.packageName,
                            category: item.category,
                            version: item.version,
                            fixedVersion: item.fixedVersion,
                            vendor: item.vendor,
                            fixStatus: item.fixStatus,
                            affectedServices: isNginx ? new Set(['Nginx']) : new Set(),
                            serviceCount: isNginx ? 1 : 0,
                            severityLevel: getSeverityLevel(item.severity)
                        });
                    }

                    if (!isNginx) {
                        const entry = cveMap.get(item.cveId);
                        entry.affectedServices.add(item.serviceName);
                        entry.serviceCount = entry.affectedServices.size;
                    }
                });

                return Array.from(cveMap.values())
                    .sort((a, b) => b.severityLevel - a.severityLevel || b.serviceCount - a.serviceCount)
                    .map(entry => ({
                        cveId: entry.cveId,
                        severity: entry.severity,
                        packageName: entry.packageName,
                        category: entry.category,
                        version: entry.version,
                        fixedVersion: entry.fixedVersion,
                        vendor: entry.vendor,
                        fixStatus: entry.fixStatus,
                        affectedServiceCount: entry.serviceCount,
                        affectedServices: isNginx ? ['Nginx'] : Array.from(entry.affectedServices).sort()
                    }));
            }

            // Create summary data
            function createSummaryData(detailedData, cveData) {
                const uniqueCves = new Set(detailedData.map(item => item.cveId)).size;
                const uniqueServices = new Set(detailedData.map(item => item.serviceName)).size;
                const severityCounts = { Critical: 0, High: 0, Medium: 0, Low: 0 };

                cveData.forEach(item => {
                    const severity = getNormalizedSeverity(item.severity);
                    if (severity && severityCounts[severity] !== undefined) {
                        severityCounts[severity]++;
                    }
                });

                return {
                    stats: [
                        { metric: 'Total Unique CVEs', value: uniqueCves },
                        { metric: 'Affected Services', value: uniqueServices },
                        { metric: 'Critical Vulnerabilities', value: severityCounts.Critical },
                        { metric: 'High Vulnerabilities', value: severityCounts.High },
                        { metric: 'Medium Vulnerabilities', value: severityCounts.Medium },
                        { metric: 'Low Vulnerabilities', value: severityCounts.Low }
                    ],
                    severityCounts
                };
            }

            // Display summary statistics
            function displaySummaryStats(data) {
                elements.mainStats.innerHTML = data.stats.slice(0, 2).map(stat => `
                    <div class="stat-item">
                        <h4>${stat.metric}</h4>
                        <div class="stat-value">${stat.value}</div>
                    </div>
                `).join('');

                elements.severityStats.innerHTML = data.stats.slice(2).map(stat => `
                    <div class="stat-item">
                        <h4>${stat.metric.split(' ')[0]}</h4>
                        <div class="stat-value ${stat.metric.split(' ')[0].toLowerCase()}">${stat.value}</div>
                    </div>
                `).join('');
            }

            // Display Nginx summary statistics
            function displayNginxSummaryStats(data) {
                elements.nginxMainStats.innerHTML = data.stats.slice(0, 2).map(stat => `
                    <div class="stat-item">
                        <h4>${stat.metric}</h4>
                        <div class="stat-value">${stat.value}</div>
                    </div>
                `).join('');

                elements.nginxSeverityStats.innerHTML = data.stats.slice(2).map(stat => `
                    <div class="stat-item">
                        <h4>${stat.metric.split(' ')[0]}</h4>
                        <div class="stat-value ${stat.metric.split(' ')[0].toLowerCase()}">${stat.value}</div>
                    </div>
                `).join('');
            }

            // Display service view
            function displayServiceView(data) {
                if (!data.length) {
                    elements.serviceTableContainer.innerHTML = '<p>No service data to display</p>';
                    return;
                }

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Service Name</th>
                            <th class="severity-critical">Critical</th>
                            <th class="severity-high">High</th>
                            <th class="severity-medium">Medium</th>
                            <th class="severity-low">Low</th>
                            <th>Unique CVEs</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(item => {
                            // Group CVEs by severity
                            const severityGroups = {
                                Critical: [],
                                High: [],
                                Medium: [],
                                Low: []
                            };
                            item.cveDetails.forEach(cve => {
                                if (severityGroups[cve.severity]) {
                                    severityGroups[cve.severity].push(cve.cveId);
                                }
                            });

                            // Generate HTML for each severity group
                            const severitySections = ['Critical', 'High', 'Medium', 'Low'].map(severity => {
                                if (severityGroups[severity].length > 0) {
                                    return `
                                        <div class="severity-section">
                                            <h4 class="severity-${severity.toLowerCase()}">${severity}</h4>
                                            <span>${severityGroups[severity].join(', ')}</span>
                                        </div>
                                    `;
                                }
                                return '';
                            }).filter(section => section).join('');

                            return `
                                <tr class="clickable-row">
                                    <td>${item.serviceName}</td>
                                    <td>${item.criticalCount}</td>
                                    <td>${item.highCount}</td>
                                    <td>${item.mediumCount}</td>
                                    <td>${item.lowCount}</td>
                                    <td><span class="clickable">${item.uniqueCveCount}</span></td>
                                </tr>
                                <tr class="cve-details-row">
                                    <td colspan="6" class="cve-details-cell">
                                        ${severitySections || 'No CVEs found'}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                `;

                table.querySelectorAll('.clickable-row').forEach(row => {
                    row.addEventListener('click', () => row.classList.toggle('expanded'));
                });

                table.querySelectorAll('.clickable').forEach(span => {
                    span.addEventListener('click', e => {
                        e.stopPropagation();
                        span.closest('tr').classList.toggle('expanded');
                    });
                });

                elements.serviceTableContainer.innerHTML = '';
                elements.serviceTableContainer.appendChild(table);
            }

            // Display CVE view
            function displayCveView(data) {
                if (!data.length) {
                    elements.cveTableContainer.innerHTML = '<p>No CVE data to display</p>';
                    return;
                }

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>CVE ID</th>
                            <th>Severity</th>
                            <th>Package Name</th>
                            <th>Category</th>
                            <th>Installed Version</th>
                            <th>Fixed Version</th>
                            <th>Affected Services</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(item => `
                            <tr class="clickable-row">
                                <td class="cve-id">${item.cveId}</td>
                                <td class="${getSeverityClass(item.severity)}">${item.severity}</td>
                                <td>${item.packageName}</td>
                                <td>${item.category}</td>
                                <td>${item.version}</td>
                                <td>${item.fixedVersion}</td>
                                <td><span class="clickable">${item.affectedServiceCount}</span></td>
                                <td>${item.affectedServiceCount}</td>
                            </tr>
                            <tr class="cve-details-row">
                                <td colspan="8" class="cve-details-cell">
                                    <h4>Affected Services</h4>
                                    <ul>
                                        ${item.affectedServices.map(service => `<li>${service}</li>`).join('')}
                                    </ul>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;

                table.querySelectorAll('.clickable-row').forEach(row => {
                    row.addEventListener('click', () => row.classList.toggle('expanded'));
                });

                table.querySelectorAll('.clickable').forEach(span => {
                    span.addEventListener('click', e => {
                        e.stopPropagation();
                        span.closest('tr').classList.toggle('expanded');
                    });
                });

                elements.cveTableContainer.innerHTML = '';
                elements.cveTableContainer.appendChild(table);
            }

            // Display Nginx CVE view
            function displayNginxCveView(data) {
                if (!data.length) {
                    elements.nginxCveTableContainer.innerHTML = '<p>No Nginx CVE data to display</p>';
                    return;
                }

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>CVE ID</th>
                            <th>Severity</th>
                            <th>Package Name</th>
                            <th>Category</th>
                            <th>Installed Version</th>
                            <th>Fixed Version</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(item => `
                            <tr>
                                <td class="cve-id">${item.cveId}</td>
                                <td class="${getSeverityClass(item.severity)}">${item.severity}</td>
                                <td>${item.packageName}</td>
                                <td>${item.category}</td>
                                <td>${item.version}</td>
                                <td>${item.fixedVersion}</td>
                                <td>${item.affectedServiceCount}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;

                elements.nginxCveTableContainer.innerHTML = '';
                elements.nginxCveTableContainer.appendChild(table);
            }

            // Download CSV
            function downloadCSV(data, filenamePrefix) {
                if (!data.length) return;

                const headers = Object.keys(data[0]);
                const rows = data.map(row => 
                    headers.map(fieldName => {
                        let value = row[fieldName];
                        if (fieldName === 'severity') value = getNormalizedSeverity(value);
                        if (fieldName === 'affectedServices' && Array.isArray(row[fieldName])) {
                            value = row[fieldName].join(', ');
                        }
                        return `"${String(value || '').replace(/"/g, '""')}"`;
                    }).join(',')
                );

                const csvContent = [headers.join(','), ...rows].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `${filenamePrefix}_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Helper functions
            function getSeverityClass(severity) {
                const normalized = getNormalizedSeverity(severity);
                return normalized ? `severity-${normalized.toLowerCase()}` : '';
            }

            function getNormalizedSeverity(severity) {
                if (!severity) return '';
                const lower = severity.toLowerCase();
                if (lower.includes('critical')) return 'Critical';
                if (lower.includes('high')) return 'High';
                if (lower.includes('medium')) return 'Medium';
                if (lower.includes('low')) return 'Low';
                return severity.charAt(0).toUpperCase() + severity.slice(1);
            }

            function getSeverityLevel(severity) {
                const normalized = getNormalizedSeverity(severity);
                return {
                    'Critical': 4,
                    'High': 3,
                    'Medium': 2,
                    'Low': 1
                }[normalized] || 0;
            }

            function showStatus(message, type) {
                elements.statusDiv.textContent = message;
                elements.statusDiv.className = `status ${type}`;
                elements.statusDiv.style.display = 'block';
            }

            // Initialize
            initEventListeners();
        });
    </script>
</body>
</html>
